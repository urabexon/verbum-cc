[config]
skip_core_tasks = true

[tasks.build]
script = "cargo build --release"

[tasks.test]
script = '''
#!/usr/bin/env bash
./debug.sh 0 0
./debug.sh 42 42
./debug.sh 47 "5+6*7"
./debug.sh 25 "5*(9-4)"
./debug.sh 6  "24/4"
./debug.sh 4  "7-6/2"
./debug.sh 2  "-3+5"
./debug.sh 236 "-(2+3)*4"
./debug.sh 6  "+6"
./debug.sh 5  "--5"
./debug.sh 8  "-(-8)"
./debug.sh 7  "+(+7)"
./debug.sh 14 "-(1-15)"
./debug.sh 1  "-(2-3)"
./debug.sh 1 "0==0"
./debug.sh 0 "0!=0"
./debug.sh 1 "1<2"
./debug.sh 0 "2<1"
./debug.sh 1 "2<=2"
./debug.sh 0 "3<=2"
./debug.sh 1 "3>2"
./debug.sh 1 "3>=3"
./debug.sh 2 "if(1) 2; else 3;"
./debug.sh 3 "if(0) 2; else 3;"
./debug.sh 3 "1;2;3;"
./debug.sh 42 "while(0) 1; 42;"
./debug.sh 5  "a = 5; a;"
./debug.sh 8  "a = 3; b = 5; a + b;"
./debug.sh 20 "a = b = 10; a + b;"
./debug.sh 15 "a = 10; a = a + 5; a;"
./debug.sh 10 "a = 0; while(a < 10) a = a + 1; a;"
./debug.sh 55 "s = 0; i = 1; while(i <= 10) { s = s + i; i = i + 1; } s;"
./debug.sh 55 "s = 0; for(i = 1; i <= 10; i = i + 1) s = s + i; s;"
./debug.sh 10 "for(i = 0; i < 10; i = i + 1) 0; i;"
./debug.sh 120 "f = 1; for(i = 1; i <= 5; i = i + 1) f = f * i; f;"
./debug.sh 5 "i = 0; do i = i + 1; while(i < 5); i;"
./debug.sh 11 "i = 10; do i = i + 1; while(i < 5); i;"
./debug.sh 1 "!0"
./debug.sh 0 "!1"
./debug.sh 0 "!42"
./debug.sh 1 "!!1"
./debug.sh 1 "1 && 1"
./debug.sh 0 "1 && 0"
./debug.sh 0 "0 && 1"
./debug.sh 0 "0 && 0"
./debug.sh 1 "1 || 1"
./debug.sh 1 "1 || 0"
./debug.sh 1 "0 || 1"
./debug.sh 0 "0 || 0"
./debug.sh 0 "a = 0; 0 && (a = 1); a;"
./debug.sh 0 "a = 0; 1 || (a = 1); a;"
./debug.sh 1 "a = 0; 1 && (a = 1); a;"
./debug.sh 1 "a = 0; 0 || (a = 1); a;"
./debug.sh 1 "1 && 2 && 3"
./debug.sh 1 "0 || 0 || 1"
./debug.sh 1 "1 < 2 && 3 > 2"
./debug.sh 0 "1 > 2 || 3 < 2"
./debug.sh 1 "10 % 3"
./debug.sh 0 "10 % 5"
./debug.sh 2 "17 % 5"
./debug.sh 0 "100 % 10"
./debug.sh 7 "7 % 10"
./debug.sh 1 "10 % 3 == 1"
./debug.sh 42 "fn foo() { return 42; } foo();"
./debug.sh 7 "fn add(a, b) { return a + b; } add(3, 4);"
./debug.sh 10 "fn double(x) { return x * 2; } double(5);"
./debug.sh 120 "fn fact(n) { if (n <= 1) return 1; else return n * fact(n - 1); } fact(5);"
./debug.sh 55 "fn fib(n) { if (n <= 1) return n; else return fib(n-1) + fib(n-2); } fib(10);"
./debug.sh 15 "fn add3(a, b, c) { return a + b + c; } add3(1, 5, 9);"
./debug.sh 100 "fn square(x) { return x * x; } fn add(a, b) { return a + b; } add(square(6), square(8));"
./debug.sh 21 "fn sum(n) { s = 0; for(i = 1; i <= n; i = i + 1) s = s + i; return s; } sum(6);"
./debug.sh 10 "x = 10; p = &x; *p;"
./debug.sh 20 "x = 10; p = &x; *p = 20; x;"
./debug.sh 30 "x = 10; p = &x; *p = *p + 20; x;"
./debug.sh 5 "a = 3; b = 5; p = &a; q = &b; *p + *q - a;"
./debug.sh 100 "x = 10; p = &x; *p = *p * *p; x;"
./debug.sh 42 "fn set(p, v) { *p = v; } x = 0; set(&x, 42); x;"
./debug.sh 15 "fn add_to(p, v) { *p = *p + v; } x = 10; add_to(&x, 5); x;"
./debug.sh 77 "fn swap(p, q) { t = *p; *p = *q; *q = t; } a = 55; b = 77; swap(&a, &b); a;"
./debug.sh 55 "fn swap(p, q) { t = *p; *p = *q; *q = t; } a = 55; b = 77; swap(&a, &b); b;"
# Array tests
./debug.sh 6 "int a[3]; a[0]=1; a[1]=2; a[2]=3; a[0]+a[1]+a[2];"
./debug.sh 20 "int a[2]; a[0]=10; a[1]=20; int *p=a; *(p+1);"
./debug.sh 30 "int a[3]; a[0]=10; a[1]=20; a[2]=30; int *p=a; *(p+2);"
./debug.sh 10 "int a[2]; a[0]=10; a[1]=20; int *p=a; *p;"
./debug.sh 3 "int a[5]; a[0]=1; a[1]=2; a[2]=3; a[3]=4; a[4]=5; a[2];"
# String literal tests
./debug.sh 104 'char *s = "hello"; s[0];'
./debug.sh 101 'char *s = "hello"; s[1];'
./debug.sh 0   'char *s = "hello"; s[5];'
./debug.sh 10  'char *s = "hello\n"; s[5];'
./debug.sh 5   'char *s = "hello"; int i=0; while(s[i]) i=i+1; i;'
'''
dependencies = [ "build" ]

[tasks.clean]
script_runner = "@shell"
script = [
  "cargo clean",
  "rm -rf ./tmp"
]
